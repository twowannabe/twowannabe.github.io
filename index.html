<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aitelka Pip-Boy Console</title>
<style>
:root {
  --bg: #040804;
  --bg-2: #081108;
  --line: #6dff8d;
  --line-strong: #2fff63;
  --line-dim: #1f7f3c;
  --text: #bafec8;
  --text-dim: #7eca91;
  --warn: #dfff83;
}

* { box-sizing: border-box; }
html, body { margin: 0; min-height: 100%; }
body {
  font-family: "Courier New", monospace;
  color: var(--text);
  background:
    radial-gradient(circle at 16% 12%, #17301a 0%, transparent 42%),
    radial-gradient(circle at 84% 78%, #102510 0%, transparent 46%),
    var(--bg);
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background: radial-gradient(circle at center, transparent 52%, rgba(0,0,0,0.48) 100%);
}

.overlay {
  position: fixed;
  inset: 0;
  padding: 18px;
  background: rgba(0, 8, 0, 0.78);
  display: flex;
  justify-content: center;
  align-items: center;
}

.popup {
  position: relative;
  width: min(980px, 100%);
  max-height: 96vh;
  overflow: auto;
  border: 2px solid var(--line-dim);
  background: linear-gradient(180deg, var(--bg-2) 0%, #060d06 100%);
  box-shadow:
    0 0 0 1px #21462a,
    0 0 32px rgba(47, 255, 99, 0.12),
    inset 0 0 28px rgba(47, 255, 99, 0.08);
}

.popup::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  opacity: 0.25;
  mix-blend-mode: screen;
  background: repeating-linear-gradient(
    to bottom,
    rgba(109, 255, 141, 0.08) 0,
    rgba(109, 255, 141, 0.08) 1px,
    transparent 2px,
    transparent 4px
  );
}

.topbar {
  position: sticky;
  top: 0;
  z-index: 3;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 14px;
  border-bottom: 1px solid var(--line-dim);
  background: #0a1c0b;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 12px;
}

.brand { color: var(--line-strong); font-weight: 700; }
.tabs { display: flex; gap: 8px; }
.tab {
  border: 1px solid #225d30;
  padding: 3px 8px;
}
.tab.active {
  background: var(--line-strong);
  color: #06210c;
  border-color: var(--line-strong);
  font-weight: 700;
}

.content {
  position: relative;
  z-index: 2;
  padding: 16px;
  display: grid;
  gap: 10px;
}

.headline,
.panel {
  border: 1px solid #1f5a2d;
  background: rgba(8, 22, 10, 0.68);
  padding: 12px;
}

h2 {
  margin: 0;
  color: var(--line-strong);
  font-size: 18px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.status {
  display: inline-block;
  margin-top: 8px;
  border: 1px solid #276f37;
  padding: 2px 8px;
  color: var(--warn);
  font-size: 12px;
}

.summary {
  margin: 10px 0 0;
  color: var(--text);
  line-height: 1.55;
  font-size: 14px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}

.panel-title {
  margin-bottom: 8px;
  color: var(--text-dim);
  font-size: 11px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.kv {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  margin-top: 6px;
  font-size: 13px;
}
.kv span:last-child {
  color: var(--line);
  text-align: right;
}

.row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  font-size: 12px;
}

.bar {
  flex: 1;
  height: 10px;
  border: 1px solid #276a38;
  background: #0b1f0f;
  overflow: hidden;
}
.bar i {
  display: block;
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, #2b9f4c, #7bff9f);
}

.list {
  list-style: none;
  margin: 0;
  padding: 0;
  font-size: 13px;
}
.list li {
  padding: 4px 0;
  border-bottom: 1px dashed #1e4e28;
}
.list li:last-child { border-bottom: none; }

.buttons {
  display: flex;
  gap: 10px;
}

button {
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 10px 14px;
  border: 1px solid #2a7240;
  background: #0a1b0c;
  color: var(--line);
  cursor: pointer;
}
button:hover {
  border-color: var(--line-strong);
  box-shadow: 0 0 10px rgba(47, 255, 99, 0.2);
}
button.accept {
  background: var(--line-strong);
  color: #06210c;
  border-color: var(--line-strong);
  font-weight: 700;
}

@media (max-width: 840px) {
  .tabs { display: none; }
  .grid { grid-template-columns: 1fr; }
  .buttons { flex-direction: column; }
}
</style>
</head>
<body>
<div class="overlay">
  <div class="popup">
    <div class="topbar">
      <span class="brand">Aitelka Vault Terminal</span>
      <div class="tabs">
        <span class="tab">STAT</span>
        <span class="tab active">DATA</span>
        <span class="tab">MAP</span>
      </div>
      <span id="build">v.111.42</span>
    </div>

    <div class="content">
      <section class="headline">
        <h2>Aitelka Profile Snapshot</h2>
        <span class="status" id="status">Prototype Mode</span>
        <p class="summary" id="summary">Loading profile and local telemetry...</p>
      </section>

      <div class="grid">
        <section class="panel">
          <div class="panel-title">Avatar Settings</div>
          <div class="kv"><span>Display Name</span><span id="display-name">-</span></div>
          <div class="kv"><span>Level / XP</span><span id="level-xp">-</span></div>
          <div class="kv"><span>Mood Label</span><span id="lisa-mood">-</span></div>
          <div class="kv"><span>Personality</span><span id="personality">-</span></div>
          <div class="kv"><span>Voice Replies</span><span id="voice-enabled">-</span></div>
          <div class="kv"><span>Write First</span><span id="write-first">-</span></div>
        </section>

        <section class="panel">
          <div class="panel-title">Global Lisa State (lisa_state)</div>
          <div class="kv"><span>Current Mood Key</span><span id="mood-key">playful</span></div>
          <div class="kv"><span>Updated At</span><span id="mood-updated">-</span></div>
          <div class="kv"><span>Check-in Status</span><span id="checkin-status">active</span></div>
          <div class="kv"><span>Scheduler</span><span>job_queue</span></div>
        </section>

        <section class="panel">
          <div class="panel-title">Activity (askgbt_logs)</div>
          <div class="kv"><span>Total Replies (7d)</span><span id="replies-7d">-</span></div>
          <div class="row"><span>Voice</span><div class="bar"><i id="voice-bar"></i></div><span id="voice-pct">0%</span></div>
          <div class="row"><span>Nudes</span><div class="bar"><i id="nudes-bar"></i></div><span id="nudes-pct">0%</span></div>
          <div class="row"><span>Media</span><div class="bar"><i id="media-bar"></i></div><span id="media-pct">0%</span></div>
        </section>

        <section class="panel">
          <div class="panel-title">Memory (user_memory)</div>
          <div class="kv"><span>Tracked Users</span><span id="tracked-users">-</span></div>
          <div class="kv"><span>Avg Message Depth</span><span id="avg-depth">-</span></div>
          <div class="kv"><span>Last Summary Refresh</span><span id="summary-updated">-</span></div>
          <div class="kv"><span>Top Topic</span><span id="top-topic">-</span></div>
        </section>

        <section class="panel">
          <div class="panel-title">Top Users (user_state)</div>
          <ul class="list" id="top-users"></ul>
        </section>

        <section class="panel">
          <div class="panel-title">Recent Events</div>
          <ul class="list" id="events"></ul>
        </section>
      </div>

      <div class="buttons">
        <button class="accept" id="refresh-btn">Refresh</button>
        <button id="copy-link-btn">Copy Link</button>
      </div>
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);

const profile = {
  name: params.get("name") || "unknown",
  customName: params.get("custom_name") || "",
  level: parseInt(params.get("level") || "0", 10),
  xp: parseInt(params.get("xp") || "0", 10),
  title: params.get("title") || "",
  doNotWriteFirst: params.get("do_not_write_first") === "1",
  voiceEnabled: params.get("voice_enabled") !== "0",
  personalityRaw: params.get("personality") || "",
  lisaMoodLabel: params.get("lisa_mood_label") || "unknown",
};

const fallback = {
  lisaState: { moodKey: "flirty", updatedAt: "2026-02-16 17:42", checkin: "active" },
  activity: { replies7d: 842, voicePct: 34, nudesPct: 12, mediaPct: 27 },
  memory: { trackedUsers: 119, avgDepth: 28, summaryUpdated: "2026-02-16 18:00", topTopic: "flirt + support" },
  topUsers: [
    { name: "@neo", level: 7, xp: 1734, streak: 24 },
    { name: "@trinity", level: 6, xp: 1202, streak: 13 },
    { name: "@morpheus", level: 6, xp: 998, streak: 9 },
  ],
  events: [
    "18:03 — mood rotated to flirty",
    "17:56 — daily compliment sent",
    "17:31 — voice reply generated",
    "17:02 — challenge delivered",
  ],
};

const API_URL = params.get("api") || "/api/lisa/overview";

function personalityLabel(value) {
  const v = (value || "").toLowerCase();
  if (!v) return "default";
  if (v.includes("неж")) return "tender";
  if (v.includes("подруг") || v.includes("bestie")) return "bestie";
  if (v.includes("пошл") || v.includes("дерз")) return "flirty";
  return "custom";
}

function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = String(value);
}

function setBar(id, pctId, value) {
  const v = Math.max(0, Math.min(100, value));
  const bar = document.getElementById(id);
  if (bar) bar.style.width = v + "%";
  setText(pctId, v + "%");
}

function renderList(id, items, formatter) {
  const ul = document.getElementById(id);
  if (!ul) return;
  ul.innerHTML = "";
  items.forEach(item => {
    const li = document.createElement("li");
    li.textContent = formatter(item);
    ul.appendChild(li);
  });
}

function applyData(source) {
  const displayName = profile.customName || profile.name;
  setText("display-name", displayName);
  setText("level-xp", profile.level > 0 ? `lvl ${profile.level} (${profile.title || "no title"}), ${profile.xp} xp` : "n/a");
  setText("lisa-mood", profile.lisaMoodLabel);
  setText("personality", personalityLabel(profile.personalityRaw));
  setText("voice-enabled", profile.voiceEnabled ? "enabled" : "disabled");
  setText("write-first", profile.doNotWriteFirst ? "disabled" : "enabled");

  setText("mood-key", source.lisaState.moodKey);
  setText("mood-updated", source.lisaState.updatedAt);
  setText("checkin-status", source.lisaState.checkin);

  setText("replies-7d", source.activity.replies7d);
  setBar("voice-bar", "voice-pct", source.activity.voicePct);
  setBar("nudes-bar", "nudes-pct", source.activity.nudesPct);
  setBar("media-bar", "media-pct", source.activity.mediaPct);

  setText("tracked-users", source.memory.trackedUsers);
  setText("avg-depth", source.memory.avgDepth);
  setText("summary-updated", source.memory.summaryUpdated);
  setText("top-topic", source.memory.topTopic);

  renderList("top-users", source.topUsers, u => `${u.name} — lvl ${u.level}, ${u.xp} xp, streak ${u.streak}`);
  renderList("events", source.events, e => e);

  setText("summary", `${displayName}, profile loaded. Pip-Boy telemetry synced from local server API.`);
  setText("status", "Synced");
}

function normalizeApiData(raw) {
  return {
    lisaState: {
      moodKey: raw?.lisa_state?.mood_key || fallback.lisaState.moodKey,
      updatedAt: raw?.lisa_state?.updated_at || fallback.lisaState.updatedAt,
      checkin: raw?.lisa_state?.checkin_status || fallback.lisaState.checkin,
    },
    activity: {
      replies7d: raw?.activity?.replies_7d ?? fallback.activity.replies7d,
      voicePct: raw?.activity?.voice_pct ?? fallback.activity.voicePct,
      nudesPct: raw?.activity?.nudes_pct ?? fallback.activity.nudesPct,
      mediaPct: raw?.activity?.media_pct ?? fallback.activity.mediaPct,
    },
    memory: {
      trackedUsers: raw?.memory?.tracked_users ?? fallback.memory.trackedUsers,
      avgDepth: raw?.memory?.avg_depth ?? fallback.memory.avgDepth,
      summaryUpdated: raw?.memory?.summary_updated || fallback.memory.summaryUpdated,
      topTopic: raw?.memory?.top_topic || fallback.memory.topTopic,
    },
    topUsers: Array.isArray(raw?.top_users) ? raw.top_users : fallback.topUsers,
    events: Array.isArray(raw?.events) ? raw.events : fallback.events,
  };
}

async function loadData() {
  try {
    const resp = await fetch(API_URL, { headers: { "Accept": "application/json" } });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    applyData(normalizeApiData(json));
  } catch (err) {
    setText("status", "Fallback (No API)");
    setText("summary", "API unavailable, showing local prototype data.");
    applyData(fallback);
  }
}

document.getElementById("refresh-btn").addEventListener("click", loadData);
document.getElementById("copy-link-btn").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(window.location.href);
    setText("status", "Link Copied");
  } catch {
    setText("status", "Copy Failed");
  }
});

loadData();
</script>
</body>
</html>
